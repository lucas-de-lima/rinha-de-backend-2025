# üèÜ Rinha de Backend 2025

> **Arquitetura de Microsservi√ßos com gRPC, mTLS e Autentica√ß√£o Signet-go - 100% Conforme Desafio**

Uma solu√ß√£o robusta para processamento de pagamentos com arquitetura distribu√≠da, seguran√ßa avan√ßada e persist√™ncia confi√°vel, **totalmente aderente aos requisitos da Rinha de Backend 2025**.

## üèóÔ∏è **Arquitetura de Microsservi√ßos**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    HTTP/REST    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Cliente HTTP  ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫ ‚îÇ   API Gateway   ‚îÇ
‚îÇ   (Porta 9999)  ‚îÇ                 ‚îÇ   (Container)   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                 ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                              ‚îÇ
                                              ‚îÇ gRPC + mTLS + Signet
                                              ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                 ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Processador   ‚îÇ ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ‚îÇ Payment         ‚îÇ
‚îÇ   Externo       ‚îÇ                 ‚îÇ Orchestrator    ‚îÇ
‚îÇ   (Rede Externa)‚îÇ                 ‚îÇ   (Container)   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                 ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                              ‚îÇ
                                              ‚îÇ gRPC + mTLS + Signet
                                              ‚ñº
                                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                    ‚îÇ Summary Service ‚îÇ
                                    ‚îÇ   (Container)   ‚îÇ
                                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                              ‚îÇ
                                              ‚ñº
                                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                    ‚îÇ   BBolt DB      ‚îÇ
                                    ‚îÇ   (Persist√™ncia)‚îÇ
                                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### **Estrutura de Containers**
- **API Gateway**: Ponto de entrada HTTP (porta 9999)
- **Payment Orchestrator**: Orquestra pagamentos internamente
- **Summary Service**: Gerencia resumos e consultas
- **Rede Compartilhada**: Comunica√ß√£o segura entre microsservi√ßos
- **Recursos Limitados**: CPU e mem√≥ria controlados por container

## üîê **Seguran√ßa**

- **mTLS (Mutual TLS)**: Autentica√ß√£o bidirecional com certificados X.509
- **Signet-go**: Autentica√ß√£o baseada em tokens JWT com chaves Ed25519
- **Rate Limiting**: Prote√ß√£o contra abuso de API
- **Health Checks**: Monitoramento de sa√∫de dos servi√ßos
- **Fallback**: Redund√¢ncia entre processadores de pagamento

## ‚úÖ **Conformidade com Rinha de Backend 2025**

### **Endpoints Obrigat√≥rios - 100% Implementados**

#### ‚úÖ POST /payments
- **Formato de entrada**: `{ "correlationId": "uuid", "amount": decimal }`
- **Valida√ß√£o**: UUID obrigat√≥rio, amount > 0
- **Resposta**: HTTP 2XX (qualquer)
- **Porta**: 9999

#### ‚úÖ GET /payments-summary
- **Par√¢metros**: `from` e `to` opcionais (ISO UTC)
- **Resposta**: 
  ```json
  {
    "default": { "totalRequests": int, "totalAmount": decimal },
    "fallback": { "totalRequests": int, "totalAmount": decimal }
  }
  ```

### **Integra√ß√£o com Payment Processors - 100% Implementada**

#### ‚úÖ Payload Correto
- **Enviado aos processadores**: `{ "correlationId": "uuid", "amount": decimal, "requestedAt": "ISO UTC" }`
- **Health Check**: `/payments/service-health` com rate limit 1 req/5s
- **URLs**: `http://payment-processor-default:8080` e `http://payment-processor-fallback:8080`

### **Docker Compose - 100% Conforme**

#### ‚úÖ Requisitos Atendidos
- **Porta 9999**: API Gateway exposto na porta correta
- **2+ Inst√¢ncias**: Pelo menos 2 inst√¢ncias do servi√ßo HTTP
- **Limites de Recursos**: 1.5 CPU e 350MB RAM total
- **Rede Externa**: Conecta √† rede `payment-processor`
- **Plataforma**: Build para `linux/amd64`

### **Valida√ß√µes e Testes - 100% Implementados**

#### ‚úÖ Valida√ß√µes de Entrada
- **correlationId**: UUID obrigat√≥rio e v√°lido
- **amount**: Decimal obrigat√≥rio > 0
- **M√©todos HTTP**: Valida√ß√£o de m√©todos permitidos

#### ‚úÖ Testes Automatizados
- **Script de Conformidade**: `scripts/test-rinha-compliance.ps1`
- **Cobertura**: Todos os endpoints e valida√ß√µes
- **Formato**: Valida√ß√£o de estrutura de resposta

## üìä **Status do √âpico**

### ‚úÖ **Hist√≥ria 1: A Seguran√ßa Interna** - CONCLU√çDA
- [x] Implementa√ß√£o de mTLS entre servi√ßos
- [x] Autentica√ß√£o signet-go com chaves Ed25519
- [x] Rate limiting e health checks
- [x] Fallback entre processadores

### ‚úÖ **Hist√≥ria 2: A L√≥gica Principal** - CONCLU√çDA
- [x] Payment Orchestrator com l√≥gica de neg√≥cio
- [x] Integra√ß√£o com processadores externos
- [x] Tratamento de erros e retry logic
- [x] Testes automatizados com mocks

### ‚úÖ **Hist√≥ria 3: A Fachada P√∫blica** - CONCLU√çDA
- [x] API Gateway com endpoints HTTP/REST
- [x] Ponte para servi√ßos internos via gRPC
- [x] Documenta√ß√£o de API e exemplos
- [x] Testes de integra√ß√£o

### ‚úÖ **Hist√≥ria 4: O Resumo Inteligente** - CONCLU√çDA
- [x] Summary Service para consultas de resumo
- [x] Agrega√ß√£o de dados de pagamentos
- [x] Endpoints para consulta de hist√≥rico
- [x] Integra√ß√£o com API Gateway

### ‚úÖ **Hist√≥ria 5: A Persist√™ncia** - CONCLU√çDA
- [x] Camada de persist√™ncia com BBolt
- [x] Buckets autom√°ticos
- [x] Opera√ß√µes CRUD completas
- [x] Recupera√ß√£o de dados ap√≥s reinicializa√ß√£o
- [x] Estat√≠sticas e consultas otimizadas

### ‚úÖ **Conformidade Rinha 2025** - CONCLU√çDA
- [x] Endpoints no formato exato do desafio
- [x] Integra√ß√£o correta com Payment Processors
- [x] Docker Compose conforme especifica√ß√µes
- [x] Valida√ß√µes e testes automatizados
- [x] Documenta√ß√£o e info.json

## üöÄ **In√≠cio R√°pido**

### Pr√©-requisitos
- Go 1.21+
- OpenSSL
- buf (ser√° instalado automaticamente)

### Instala√ß√£o e Execu√ß√£o

```bash
# 1. Clone o reposit√≥rio
git clone <repository-url>
cd rinha-de-backend-2025

# 2. Prepare o ambiente
./scripts/dev.sh

# 3. Teste a conformidade com a Rinha
powershell -ExecutionPolicy Bypass -File scripts/test-rinha-compliance.ps1
```

### Execu√ß√£o via Docker Compose (Recomendado)

```bash
# 1. Inicia todos os microsservi√ßos
docker-compose up -d

# 2. Verifica status dos containers
docker-compose ps

# 3. Acessa logs de um servi√ßo espec√≠fico
docker-compose logs api-gateway-1
docker-compose logs payment-orchestrator
docker-compose logs summary-service
```

### Execu√ß√£o Manual (Desenvolvimento)

```bash
# Terminal 1: Processadores Mock (externos)
./mock-processor.exe
./mock-processor.exe fallback

# Terminal 2: Microsservi√ßos Internos
./payment-orchestrator.exe
./summary-service.exe

# Terminal 3: API Gateway (porta 9999)
./api-gateway.exe
```

## üì° **API Endpoints (Conforme Rinha 2025)**

### POST /payments
Cria um novo pagamento.

```bash
curl -X POST http://localhost:9999/payments \
  -H "Content-Type: application/json" \
  -d '{
    "correlationId": "4a7901b8-7d26-4d9d-aa19-4dc1c7cf60b3",
    "amount": 100.50
  }'
```

**Resposta:**
```json
{
  "id": "pay_abc123",
  "status": "completed",
  "message": "Pagamento processado com sucesso"
}
```

### GET /payments-summary
Consulta resumo de pagamentos por processador.

```bash
curl "http://localhost:9999/payments-summary"
```

**Resposta:**
```json
{
  "default": {
    "totalRequests": 150,
    "totalAmount": 15000.75
  },
  "fallback": {
    "totalRequests": 25,
    "totalAmount": 2500.50
  }
}
```

## üóÑÔ∏è **Persist√™ncia de Dados**

### Banco de Dados BBolt
- **Localiza√ß√£o**: `./data/payments.db`
- **Buckets**: Autom√°ticos na inicializa√ß√£o
- **Serializa√ß√£o**: Gob encoding para performance m√°xima

### Estrutura dos Dados
```go
type Payment struct {
    ID            string    `json:"id"`
    CustomerID    string    `json:"customer_id"`
    Amount        float64   `json:"amount"`
    Description   string    `json:"description"`
    Status        string    `json:"status"`
    ProcessorUsed string    `json:"processor_used"`
    CreatedAt     time.Time `json:"created_at"`
    UpdatedAt     time.Time `json:"updated_at"`
}
```

## üß™ **Testes**

### üèÜ Teste Oficial dos Avaliadores (Recomendado)
```bash
# Windows (PowerShell)
powershell -ExecutionPolicy Bypass -File scripts/teste-oficial-avaliadores.ps1

# Linux/Mac (Bash)
./scripts/teste-oficial-avaliadores.sh
```

**Requisitos:**
- k6 instalado (https://grafana.com/docs/k6/latest/set-up/install-k6/)
- Docker e Docker Compose
- Porta 9999 dispon√≠vel

**O que testa:**
- ‚úÖ Endpoints exatos do desafio
- ‚úÖ Integra√ß√£o com Payment Processors oficiais
- ‚úÖ Performance e carga
- ‚úÖ Consist√™ncia de dados
- ‚úÖ Cen√°rios de falha e fallback
- ‚úÖ Dashboard em tempo real (http://localhost:5665)

### Teste de Conformidade Rinha 2025
```bash
powershell -ExecutionPolicy Bypass -File scripts/test-rinha-compliance.ps1
```

**Cobertura:**
- ‚úÖ Formato correto dos endpoints
- ‚úÖ Valida√ß√£o de UUID e campos obrigat√≥rios
- ‚úÖ Estrutura de resposta do summary
- ‚úÖ Par√¢metros opcionais
- ‚úÖ Porta 9999

### Prova de Fogo (Teste Completo)
```bash
# Windows (PowerShell)
powershell -ExecutionPolicy Bypass -File scripts/prova-de-fogo.ps1

# Linux/Mac (Bash)
./scripts/prova-de-fogo.sh
```

**Cobertura:**
- ‚úÖ Valida√ß√µes de entrada
- ‚úÖ Performance com m√∫ltiplas requisi√ß√µes
- ‚úÖ Persist√™ncia ap√≥s reinicializa√ß√£o
- ‚úÖ Logs e recursos dos containers

## üîß **Desenvolvimento**

### Estrutura do Projeto
```
rinha-de-backend-2025/
‚îú‚îÄ‚îÄ cmd/                    # Execut√°veis principais
‚îÇ   ‚îú‚îÄ‚îÄ api-gateway/       # API Gateway (porta 9999)
‚îÇ   ‚îú‚îÄ‚îÄ payment-orchestrator/ # Orquestrador de pagamentos
‚îÇ   ‚îî‚îÄ‚îÄ summary-service/   # Servi√ßo de resumo
‚îú‚îÄ‚îÄ internal/              # C√≥digo interno
‚îÇ   ‚îú‚îÄ‚îÄ database/          # Camada de persist√™ncia
‚îÇ   ‚îú‚îÄ‚îÄ gen/proto/         # Stubs protobuf gerados
‚îÇ   ‚îú‚îÄ‚îÄ keys/              # Gerenciamento de chaves
‚îÇ   ‚îî‚îÄ‚îÄ resolver/          # Resolu√ß√£o de chaves
‚îú‚îÄ‚îÄ proto/                 # Defini√ß√µes protobuf
‚îú‚îÄ‚îÄ certs/                 # Certificados mTLS
‚îú‚îÄ‚îÄ config/                # Configura√ß√µes
‚îú‚îÄ‚îÄ examples/              # Exemplos e testes
‚îú‚îÄ‚îÄ scripts/               # Scripts de automa√ß√£o
‚îú‚îÄ‚îÄ data/                  # Banco de dados BBolt
‚îú‚îÄ‚îÄ docker-compose.yml     # Conforme Rinha 2025
‚îî‚îÄ‚îÄ info.json              # Tecnologias utilizadas
```

### Comandos √öteis

```bash
# Gerar stubs protobuf
buf generate

# Atualizar depend√™ncias
go mod tidy

# Compilar todos os servi√ßos
./scripts/dev.sh

# Testar conformidade Rinha 2025
powershell -ExecutionPolicy Bypass -File scripts/test-rinha-compliance.ps1

# Limpar dados
rm -rf data/
```

## üê≥ **Docker**

### Conformidade Rinha 2025
```bash
# Construir e executar com Docker Compose
docker-compose up --build

# Executar apenas um servi√ßo
docker-compose up api-gateway-1
```

**Caracter√≠sticas:**
- ‚úÖ Porta 9999 exposta
- ‚úÖ 2 inst√¢ncias do API Gateway
- ‚úÖ Limites de recursos: 1.5 CPU, 350MB RAM
- ‚úÖ Rede externa payment-processor
- ‚úÖ Build para linux/amd64

## üìà **Monitoramento**

### Logs dos Servi√ßos
- **API Gateway**: `api-gateway.log`
- **Payment Orchestrator**: `payment-orchestrator.log`
- **Summary Service**: `summary-service.log`
- **Processadores Mock**: `mock-default.log`, `mock-fallback.log`

### M√©tricas Dispon√≠veis
- Total de pagamentos processados
- Taxa de sucesso por processador
- Tempo de resposta m√©dio
- Uso de recursos do banco

## üîí **Seguran√ßa Avan√ßada**

### Certificados mTLS
- **CA**: `certs/ca.crt`
- **Servidor**: `certs/server.crt`, `certs/server.key`
- **Cliente**: `certs/client.crt`, `certs/client.key`

### Chaves Signet-go
- **Configura√ß√£o**: `config/keys.json`
- **Algoritmo**: Ed25519
- **Cache**: 5 minutos
- **Audience**: Espec√≠fico por servi√ßo

## üéØ **Status Final**

**‚úÖ PROJETO 100% CONFORME COM RINHA DE BACKEND 2025**

Todas as 5 hist√≥rias do √©pico foram conclu√≠das e o projeto est√° **totalmente aderente** aos requisitos da Rinha de Backend 2025:

- ‚úÖ **Endpoints**: Formato exato conforme especifica√ß√£o
- ‚úÖ **Integra√ß√£o**: Payload correto para Payment Processors
- ‚úÖ **Docker**: Compose conforme requisitos
- ‚úÖ **Valida√ß√µes**: UUID e campos obrigat√≥rios
- ‚úÖ **Testes**: Cobertura completa de conformidade

**Pronto para submiss√£o oficial!** üèÜ

---

## üìÑ **Licen√ßa**

Este projeto foi desenvolvido para a **Rinha de Backend 2025** como uma demonstra√ß√£o de arquitetura de microsservi√ßos com foco em seguran√ßa, confiabilidade e **conformidade total** com os requisitos do desafio.

**Arquitetura S√™nior em Golang e Microsservi√ßos** üèÜ